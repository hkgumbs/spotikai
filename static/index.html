<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SpotiKai</title>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link rel="icon" href="data:">
    <style>
      #play {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;

        display: flex;
        align-items: center;
        justify-content: center;

        border: none;
        border-radius: 0;
        outline: none;
        background: #1DB954;
        color: white;
        cursor: pointer;
      }
      #play:disabled {
        background: #191414;
      }
      .hide {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <form id="form" class="hide">
      <input id="password" type="password" placeholder="Password">
      <button type="submit">Submit</button>
    </form>
    <button id="play" class="hide">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-music"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
    </button>
    <audio id="stream" preload="none" mozaudiochannel="content">
      <source src="/audio.mp3" type="audio/mpeg"></source>
    </audio>
    <script>
      (function() {
        const token = window.location.hash.slice(1);
        window.history.replaceState(null, null, "#");
        if (!token) {
          window.location = "/login?v=" + (new Date).getTime();
          return;
        }

        const spotify = (method, path, params, body) => {
          return fetch(`https://api.spotify.com/v1/me/${path}?${params || ""}`, {
            method: method,
            body: body && JSON.stringify(body),
            headers: { "Authorization": `Bearer ${token}` },
          }).then(response => {
            if (response.ok) return response;
            else throw Error(response.statusText);
          });
        };

        const play = document.getElementById("play");
        play.classList.remove("hide");
        play.addEventListener("click", function start() {
          const stream = document.getElementById("stream");
          stream.addEventListener("stalled", function() {
            spotify("GET", "player/devices")
              .then(response => response.json())
              .then(({ devices }) => devices.find(x => x.name === "SpotiKai"))
              .then(({ id }) => spotify("PUT", "player", "", { play: true, device_ids: [ id ] }))
              .then(() => play.removeEventListener("click", start));
          });
          stream.play();
        });
      })();
    </script>
  </body>
</html>
