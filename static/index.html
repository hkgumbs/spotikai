<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SpotiKai</title>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%201%201%22%3E%3Crect%20width%3D%221%22%20height%3D%221%22%20fill%3D%22%231DB954%22%3E%3C%2Frect%3E%3C%2Fsvg%3E">
    <style>
      #play {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        font-size: 48px;

        display: flex;
        align-items: center;
        justify-content: center;

        border: none;
        border-radius: 0;
        outline: none;
        background: #1DB954;
        color: white;
        cursor: pointer;
      }
      #play:disabled {
        background: #191414;
      }
      .hide {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <form id="form" class="hide">
      <input id="password" type="password" placeholder="Password">
      <button type="submit">Submit</button>
    </form>
    <button id="play" class="hide">â–¶</button>
    <audio id="stream" preload="none" mozaudiochannel="content">
      <source src="/audio.mp3" type="audio/mpeg"></source>
    </audio>
    <script src="/spotify.js"></script>
    <script src="/library.js"></script>
    <script>
      (function() {
        const token = window.location.hash.slice(1);
        window.history.replaceState(null, null, "#");
        if (!token) {
          window.location = "/login?v=" + (new Date).getTime();
          return;
        }

        // NOTE: Uncomment this to update library
        // window.location = `/library#${token}`;

        const stream = document.getElementById("stream");
        const play = document.getElementById("play");
        play.classList.remove("hide");
        play.addEventListener("click", function() {
          play.disabled = true;
          stream.play();
        });

        const spotify = (method, path, params, body) => {
          return fetch(`https://api.spotify.com/v1/me/${path}?${params || ""}`, {
            method: method,
            body: body && JSON.stringify(body),
            headers: { "Authorization": `Bearer ${token}` },
          }).then(response => {
            if (response.ok) return response;
            else throw Error(response.statusText);
          });
        };

        /* https://github.com/sindresorhus/array-shuffle/blob/master/index.js */
        const shuffle = input => {
          var rand;
          var tmp;
          var len = input.length;
          var ret = input.slice();

          while (len) {
            rand = Math.floor(Math.random() * len--);
            tmp = ret[len];
            ret[len] = ret[rand];
            ret[rand] = tmp;
          }

          return ret;
        };

        const retry = () => { stream.load(); stream.play(); };
        stream.addEventListener("error", retry);
        stream.addEventListener("stalled", function() {
          spotify("GET", "player/devices")
            .then(response => response.json())
            .then(({ devices }) => devices.find(x => x.name === "SpotiKai"))
            .then(({ id }) => spotify("PUT", "player/play", `device_id=${id}`, {
              uris: shuffle(library).slice(0, 100),
            }))
            .catch(retry);
        });
      })();
    </script>
  </body>
</html>
