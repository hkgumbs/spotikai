<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SpotiKai</title>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link rel="icon" href="data:">
    <style>
      #play {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;

        display: flex;
        align-items: center;
        justify-content: center;

        border: none;
        border-radius: 0;
        outline: none;
        background: #1DB954;
        color: white;
        cursor: pointer;
      }
      #play:disabled {
        background: #191414;
      }
      .hide {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <form id="form" class="hide">
      <input id="password" type="password" placeholder="Password">
      <button type="submit">Submit</button>
    </form>
    <button id="play" class="hide">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-music"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
    </button>
    <audio id="stream" preload="none" mozaudiochannel="content">
      <source src="/audio.mp3" type="audio/mpeg"></source>
    </audio>
    <script>
      (function() {
        const token = window.location.hash.slice(1);
        window.history.replaceState(null, null, "#");
        if (!token) {
          window.location = "/login?v=" + (new Date).getTime();
          return;
        }

        const stream = document.getElementById("stream");
        const play = document.getElementById("play");
        play.classList.remove("hide");
        play.addEventListener("click", function start() {
          play.disabled = true;
          stream.play();
        });

        const spotify = (method, path, params, body) => {
          return fetch(`https://api.spotify.com/v1/me/${path}?${params || ""}`, {
            method: method,
            body: body && JSON.stringify(body),
            headers: { "Authorization": `Bearer ${token}` },
          }).then(response => {
            if (response.ok) return response;
            else throw Error(response.statusText);
          });
        };

        const getTracks = (library, params) => {
          return spotify("GET", "tracks", params)
            .then(response => response.json())
            .then(body => {
              body.items.forEach(item => library.push(item.track.uri));
              return body.next
                ? getTracks(library, new URL(body.next).search.slice(1))
                : library;
            });
        };

        /* https://github.com/sindresorhus/array-shuffle/blob/master/index.js */
        const shuffle = input => {
          var rand;
          var tmp;
          var len = input.length;
          var ret = input.slice();

          while (len) {
            rand = Math.floor(Math.random() * len--);
            tmp = ret[len];
            ret[len] = ret[rand];
            ret[rand] = tmp;
          }

          return ret;
        };

        stream.addEventListener("stalled", function() {
          spotify("GET", "player/devices")
            .then(response => response.json())
            .then(({ devices }) => devices.find(x => x.name === "SpotiKai"))
            .then(device => {
              getTracks([], "limit=50").then(library => {
                return spotify("PUT", "player/play", `device_id=${device.id}`, {
                  uris: shuffle(library).slice(0, 100),
                });
              });
            });
        });
      })();
    </script>
  </body>
</html>
